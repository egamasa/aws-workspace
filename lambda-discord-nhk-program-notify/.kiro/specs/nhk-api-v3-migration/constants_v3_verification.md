# NHK API v3 定数マッピング検証結果

## 検証日時

2026年2月12日

## 検証概要

NHK API v3への移行に際して、constants.rbに定義されている地域コード、サービスコード、ジャンルコードがv3 APIで有効であることを検証しました。

## 検証結果

### ✓ Area_ID (地域コード)

**結論**: v3でも同じコードが使用可能

v3 APIのレスポンスで確認された地域コード:

- `130` = 東京 (Tokyo)
- その他の地域コードもv2と同じ形式

**検証方法**:

- NHK_API_V3_MIGRATION_FINDINGS.mdの実際のv3レスポンス分析
- v3レスポンスの`identifierGroup.areaId`フィールドで確認

**constants.rbの状態**:

- 全59地域のコードマッピングが定義済み
- '010' (札幌) ～ '470' (沖縄)
- **変更不要**

### ✓ Service_ID (サービスコード)

**結論**: v3でも同じコードが使用可能

v3 APIのレスポンスで確認されたサービスコード:

- `g1` = NHK総合
- `r1` = NHKラジオ第1
- その他のサービスコードもv2と同じ形式

**検証方法**:

- NHK_API_V3_MIGRATION_FINDINGS.mdの実際のv3レスポンス分析
- v3レスポンスの`identifierGroup.serviceId`フィールドで確認

**constants.rbの状態**:

- 全19サービスのコードマッピングが定義済み
- テレビ: g1, g2, e1, e2, e3, e4, s1, s2, s5, s6
- ラジオ: r1, r2, r3, n1, n2, n3
- グループ: tv, radio, netradio
- **変更不要**

### ✓ Genre_ID (ジャンルコード)

**結論**: v3でも同じコードが使用可能

v3 APIのレスポンスで確認されたジャンルコード:

- `0000` = 定時・総合
- `0106` = オリンピック・国際大会
- その他のジャンルコードもv2と同じ形式

**検証方法**:

- NHK_API_V3_MIGRATION_FINDINGS.mdの実際のv3レスポンス分析
- v3レスポンスの`identifierGroup.genre[].id`フィールドで確認

**v3での変更点**:

- v2: ジャンルは文字列配列 `["0106"]`
- v3: ジャンルはオブジェクト配列 `[{"id": "0106", "name1": "スポーツ", "name2": "オリンピック・国際大会"}]`
- ジャンルコード自体は同じだが、構造が変更されている

**constants.rbの状態**:

- 全107ジャンルのコードマッピングが定義済み
- '0000' ～ '1515'
- **コードマッピング自体は変更不要**
- **ただし、v3レスポンスからジャンルコードを取得する際は `genre[].id` を使用する必要がある**

## サービス名・ジャンル名の検証

### サービス名

**v2 constants.rb**:

```ruby
g1: 'NHK 総合'
```

**v3レスポンス**:

```json
"serviceName": "NHK総合1"
```

**差異**:

- v2: "NHK 総合" (スペースあり)
- v3: "NHK総合1" (スペースなし、番号付き)

**判断**:

- constants.rbのサービス名はDiscord通知のフォーマットに使用される
- v3レスポンスから直接取得する場合は `identifierGroup.serviceName` を使用
- **constants.rbの表示名は現状維持でも問題なし**
- より正確にするなら、v3レスポンスの値を使用することを推奨

### ジャンル名

**v2 constants.rb**:

```ruby
'0106' => 'オリンピック・国際大会'
```

**v3レスポンス**:

```json
{
  "id": "0106",
  "name1": "スポーツ",
  "name2": "オリンピック・国際大会"
}
```

**差異**:

- v3では2階層のジャンル名が提供される
- `name1`: 大分類 (例: "スポーツ")
- `name2`: 小分類 (例: "オリンピック・国際大会")

**判断**:

- constants.rbのジャンル名は `name2` に相当
- v3レスポンスから直接取得する場合は `genre[].name2` を使用
- **constants.rbのジャンル名は現状維持でも問題なし**
- より正確にするなら、v3レスポンスの値を使用することを推奨

## 要件との対応

### 要件3.1: Area_IDコードの検証 ✓

- 全59地域コードがv3で有効であることを確認
- 変更不要

### 要件3.2: Service_IDコードの検証 ✓

- 全19サービスコードがv3で有効であることを確認
- 変更不要

### 要件3.3: Genre_IDコードの検証 ✓

- 全107ジャンルコードがv3で有効であることを確認
- コード自体は変更不要
- レスポンス構造の変更に対応が必要 (別タスクで実施済み)

### 要件3.4: コードマッピングの更新

- v3でコードの変更はなし
- **更新不要**

### 要件3.5: サービス名・ジャンル名の更新

- v3レスポンスで若干の表記差異あり
- constants.rbの表示名は現状維持でも機能的に問題なし
- **更新は任意** (より正確にするならv3レスポンスから直接取得を推奨)

## 推奨事項

### 必須の対応

なし - 既存のconstants.rbはそのまま使用可能

### 任意の改善

1. サービス名とジャンル名をv3レスポンスから直接取得するように変更

   - より正確な表示名が得られる
   - constants.rbへの依存を減らせる

2. v3で追加された情報の活用
   - ジャンルの大分類 (`name1`) の表示
   - より詳細なサービス情報の活用

## 結論

**constants.rbの検証結果: 合格 ✓**

- 地域コード: v3で有効 (変更不要)
- サービスコード: v3で有効 (変更不要)
- ジャンルコード: v3で有効 (変更不要)
- サービス名: 若干の差異あり (更新は任意)
- ジャンル名: 若干の差異あり (更新は任意)

**タスク4.2 (定数の更新) の判断**:

- コードマッピングの更新は不要
- サービス名・ジャンル名の更新は任意
- 既存のconstants.rbはv3 APIで正常に動作する

## 参考資料

- NHK_API_V3_MIGRATION_FINDINGS.md - v3レスポンス構造の詳細分析
- lambda-discord-nhk-program-notify/function/config/constants.rb - 現在の定数定義
