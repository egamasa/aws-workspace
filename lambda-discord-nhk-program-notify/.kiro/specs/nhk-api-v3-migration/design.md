# 設計書

## 概要

本設計書は、NHK番組通知Lambda関数をNHK番組表API v2からv3へ移行するための技術設計を定義します。移行の主な目的は、v2 APIの廃止に対応しながら、既存のすべての機能を維持することです。

主な変更点:

- APIエンドポイントURLの更新
- APIレスポンス形式の変更への対応
- 地域・サービス・ジャンルコードの検証と更新
- エラーハンドリングの強化

## アーキテクチャ

### 現在のアーキテクチャ

```
EventBridge Rule → Lambda Function → NHK API v2 → Lambda Function → Discord Webhook
                         ↓
                   SSM Parameter Store
                   (API Key, Webhook URL)
```

### 移行後のアーキテクチャ

```
EventBridge Rule → Lambda Function → NHK API v3 → Lambda Function → Discord Webhook
                         ↓
                   SSM Parameter Store
                   (API Key, Webhook URL)
```

アーキテクチャの基本構造は変更なし。APIエンドポイントとレスポンス処理ロジックのみを更新します。

## コンポーネントとインターフェース

### 1. APIクライアントモジュール

#### 責務

- NHK API v3へのHTTPリクエスト
- APIキーの認証処理
- レスポンスの取得とエラーハンドリング

#### インターフェース

```ruby
# v2 (現在)
API_BASE_URL_GENRE = 'https://api.nhk.or.jp/v2/pg/genre/'
API_BASE_URL_LIST = 'https://api.nhk.or.jp/v2/pg/list/'

# v3 (移行後)
# 注: 実際のv3エンドポイントはNHK API Portal (https://api-portal.nhk.or.jp/) で確認が必要
API_BASE_URL_GENRE = 'https://api.nhk.or.jp/v3/pg/genre/'
API_BASE_URL_LIST = 'https://api.nhk.or.jp/v3/pg/list/'
```

#### 主な変更点

1. ベースURLのバージョン番号を`v2`から`v3`に変更
2. APIキーの渡し方が変更されている可能性を考慮(クエリパラメータ vs ヘッダー)
3. レスポンスステータスコードとエラー形式の確認

### 2. レスポンスパーサーモジュール

#### 責務

- v3 APIレスポンスのJSON解析
- 番組データの抽出とマッピング
- データ構造の正規化

#### v2レスポンス構造(現在)

```ruby
{
  "list": {
    "g1": [
      {
        "id": "...",
        "title": "番組タイトル",
        "start_time": "2024-01-01T20:00:00+09:00",
        "end_time": "2024-01-01T21:00:00+09:00",
        "content": "番組内容",
        "service": {
          "id": "g1",
          "name": "NHK 総合"
        },
        "area": {
          "id": "130",
          "name": "東京"
        }
      }
    ]
  }
}
```

#### v3レスポンス構造の想定変更点

- フィールド名の変更可能性(例: `start_time` → `startTime`)
- ネスト構造の変更
- 新しいメタデータフィールドの追加
- タイムスタンプ形式の変更

注: 実際のv3レスポンス構造はAPI仕様書で確認し、必要に応じてパーサーロジックを調整する必要があります。

### 3. 番組フィルタリングモジュール

#### 責務

- キーワード検索のフィルタリング
- BS8K番組の除外
- サブチャンネル重複の削除
- 開始時刻によるソート

#### 処理フロー

```
1. APIレスポンスから番組リストを取得
2. ジャンル検索の場合: すべての番組を抽出
3. キーワード検索の場合: 指定フィールドでキーワードマッチング
4. BS8K_Filter有効時: service.id == 's6'の番組を除外
5. 重複削除: 同じtitleとstart_timeの番組を削除
6. 開始時刻の昇順でソート
```

このモジュールは基本的に変更不要ですが、v3のフィールド名変更に対応する必要があります。

### 4. Discord通知モジュール

#### 責務

- Discord webhookへのメッセージ送信
- 番組情報のフォーマット
- エラーハンドリング

#### メッセージ形式

```
タイトル: NHK "{ジャンル名/キーワード}" の番組放送情報

フィールド:
- 番組タイトル
- サービス名(地域名) / 開始日時
- 番組内容
```

このモジュールは変更不要ですが、v3のフィールド名変更に対応する必要があります。

## データモデル

### 番組データ構造

```ruby
# 内部データモデル(変更なし)
program = {
  'id' => String,           # 番組ID
  'title' => String,        # 番組タイトル
  'start_time' => String,   # 開始時刻(ISO 8601形式)
  'end_time' => String,     # 終了時刻(ISO 8601形式)
  'content' => String,      # 番組内容
  'service' => {
    'id' => String,         # サービスID (g1, e1, s1, etc.)
    'name' => String        # サービス名
  },
  'area' => {
    'id' => String,         # 地域ID (130, etc.)
    'name' => String        # 地域名
  }
}
```

### Lambdaイベントペイロード

```ruby
# 変更なし
[
  {
    'days_after' => Integer,    # 今日からの日数(0=今日、1=明日)
    'area' => String,           # 地域名(tokyo, osaka, etc.) デフォルト: 'tokyo'
    'service' => String,        # サービスID (g1, e1, s1, etc.)
    'genre' => String,          # ジャンルID (0300, etc.) ※ジャンル検索時のみ
    'keyword' => String,        # 検索キーワード ※キーワード検索時のみ
    'items' => Array<String>    # 検索対象フィールド ['title', 'content'] ※キーワード検索時のみ
  }
]
```

### 定数マッピング

```ruby
# constants.rb
module Constants
  # 地域コード: v3で変更がないか確認が必要
  AREA = {
    tokyo: '130',
    osaka: '270',
    # ... 他の地域
  }

  # サービスコード: v3で変更がないか確認が必要
  SERVICE = {
    g1: 'NHK 総合',
    e1: 'NHK Eテレ',
    s1: 'NHK BS',
    # ... 他のサービス
  }

  # ジャンルコード: v3で変更がないか確認が必要
  GENRE = {
    '0300' => '国内ドラマ',
    '0400' => '音楽',
    # ... 他のジャンル
  }
end
```

## 正確性プロパティ

プロパティとは、システムのすべての有効な実行において真であるべき特性または動作のことです。プロパティは、人間が読める仕様と機械で検証可能な正確性保証との橋渡しとなります。

### プロパティ1: v3レスポンスの正しい解析

*任意の*有効なNHK API v3レスポンスに対して、Lambda関数はJSON構造を正しく解析し、すべての番組データを抽出できること

**検証: 要件 2.1**

### プロパティ2: フィールドマッピングの完全性

*任意の*番組データに対して、v3レスポンスフィールドから内部データモデルへのマッピングが行われた後、すべての必須フィールド(title、start_time、content、service、area)が存在すること

**検証: 要件 2.2**

### プロパティ3: 番組リストの正しい反復処理

*任意の*v3 API番組リストレスポンスに対して、Lambda関数はすべての番組を漏れなく処理すること

**検証: 要件 2.4**

### プロパティ4: ジャンル検索の一貫性

*任意の*ジャンルIDと日付に対して、v3 APIから取得される番組は指定されたジャンルに一致すること

**検証: 要件 4.1**

### プロパティ5: キーワードフィルタリングの正確性

*任意の*キーワードと番組リストに対して、フィルタリング後の番組はすべて指定されたフィールド(title、content等)にキーワードを含むこと

**検証: 要件 4.2**

### プロパティ6: BS8K除外の正確性

*任意の*番組リストに対して、BS8K_Filterが有効な場合、フィルタリング後の番組にservice.id == 's6'の番組が含まれないこと

**検証: 要件 4.3**

### プロパティ7: サブチャンネル重複削除の正確性

*任意の*番組リストに対して、重複削除後の番組リストには同じtitleとstart_timeを持つ番組が複数存在しないこと

**検証: 要件 4.4**

### プロパティ8: 開始時刻ソートの正確性

*任意の*番組リストに対して、ソート後の番組リストはstart_timeの昇順に並んでいること

**検証: 要件 4.5**

### プロパティ9: Discordメッセージフォーマットの一貫性

*任意の*番組データに対して、生成されるDiscordメッセージには番組タイトル、サービス名、地域名、開始日時、番組内容が含まれること

**検証: 要件 4.6**

### プロパティ10: イベントペイロード互換性

*任意の*有効なLambdaイベントペイロード(days_after、area、service、genre、keyword、items)に対して、Lambda関数はエラーなく処理を完了すること

**検証: 要件 4.7**

### プロパティ11: APIエラーの適切な処理

*任意の*NHK API v3エラーレスポンス(4xx、5xx)に対して、Lambda関数はクラッシュせずにエラーを処理し、適切なログを出力すること

**検証: 要件 6.1, 6.2**

### プロパティ12: 不正レスポンスの処理

*任意の*不正なJSON形式または予期しない構造のレスポンスに対して、Lambda関数は解析エラーを適切に処理し、クラッシュしないこと

**検証: 要件 6.3**

## エラーハンドリング

### エラーカテゴリ

#### 1. API通信エラー

- ネットワークタイムアウト
- 接続エラー
- HTTPステータスエラー(4xx、5xx)

**処理方針:**

```ruby
begin
  response = Net::HTTP.get_response(URI(url))
  unless response.is_a?(Net::HTTPSuccess)
    puts "API Error: #{response.code} - #{response.message}"
    return nil
  end
rescue StandardError => e
  puts "Network Error: #{e.message}"
  return nil
end
```

#### 2. レスポンス解析エラー

- 不正なJSON形式
- 予期しないフィールド構造
- 欠損フィールド

**処理方針:**

```ruby
begin
  data = JSON.parse(response.body)
  validate_response_structure(data)
rescue JSON::ParserError => e
  puts "JSON Parse Error: #{e.message}"
  return nil
rescue StandardError => e
  puts "Response Validation Error: #{e.message}"
  return nil
end
```

#### 3. Discord通知エラー

- Webhook URLの無効化
- ネットワークエラー
- レート制限

**処理方針:**

```ruby
begin
  discord_client.execute { |builder| ... }
rescue StandardError => e
  puts "Discord Notification Error: #{e.message}"
  # エラーをログに記録するが、Lambda実行は継続
end
```

#### 4. SSMパラメータ取得エラー

- パラメータが存在しない
- 権限エラー
- ネットワークエラー

**処理方針:**

```ruby
begin
  value = get_parameter(mode)
  raise "Parameter not found" if value.nil?
  value
rescue StandardError => e
  puts "SSM Parameter Error: #{e.message}"
  raise # Lambda実行を停止
end
```

### ログ出力

すべてのエラーは標準出力に出力され、CloudWatch Logsに記録されます:

- エラーの種類
- エラーメッセージ
- 発生したコンテキスト(API URL、パラメータ等)

## テスト戦略

### デュアルテストアプローチ

本プロジェクトでは、単体テストとプロパティベーステストの両方を使用します:

- **単体テスト**: 特定の例、エッジケース、エラー条件を検証
- **プロパティベーステスト**: すべての入力にわたる普遍的なプロパティを検証

両方のアプローチは補完的であり、包括的なカバレッジに必要です。

### プロパティベーステスト

Rubyのプロパティベーステストライブラリとして**Rantly**を使用します。

#### 設定

- 各プロパティテストは最低100回の反復を実行
- 各テストは設計書のプロパティを参照するコメントを含む
- タグ形式: `# Feature: nhk-api-v3-migration, Property N: [プロパティテキスト]`

#### テスト対象プロパティ

1. v3レスポンスの正しい解析(プロパティ1)
2. フィールドマッピングの完全性(プロパティ2)
3. 番組リストの正しい反復処理(プロパティ3)
4. ジャンル検索の一貫性(プロパティ4)
5. キーワードフィルタリングの正確性(プロパティ5)
6. BS8K除外の正確性(プロパティ6)
7. サブチャンネル重複削除の正確性(プロパティ7)
8. 開始時刻ソートの正確性(プロパティ8)
9. Discordメッセージフォーマットの一貫性(プロパティ9)
10. イベントペイロード互換性(プロパティ10)
11. APIエラーの適切な処理(プロパティ11)
12. 不正レスポンスの処理(プロパティ12)

### 単体テスト

RSpecを使用した単体テストで以下を検証:

#### 具体例テスト

- v3ジャンル検索エンドポイントの使用(要件 1.1)
- v3リスト検索エンドポイントの使用(要件 1.2)
- v3認証形式でのAPIキー送信(要件 1.4)
- SSMパラメータからのAPIキー取得(要件 5.1)
- SSMパラメータからのWebhook URL取得(要件 5.4)
- EXCLUDE_BS8K_PROGRAMS環境変数のサポート(要件 5.5)
- 番組が見つからない場合の通知なし(要件 6.4)
- Discord送信失敗時のエラー処理(要件 6.5)
- デフォルト地域値'tokyo'の維持(要件 10.3)
- 複数イベントオブジェクトのサポート(要件 10.4)

#### エッジケーステスト

- 空の番組リスト
- 単一の番組
- 大量の番組(100+)
- 特殊文字を含む番組タイトル
- 境界日時(深夜0時、23:59等)

#### モックとスタブ

- NHK API v3レスポンスのモック
- SSMパラメータ取得のモック
- Discord webhook送信のモック

### 統合テスト

実際のNHK API v3を使用した統合テスト:

- ジャンル検索の動作確認(要件 8.1)
- キーワード検索の動作確認(要件 8.2)
- 異なる地域コードでの動作確認(要件 8.3)
- 異なるサービスIDでの動作確認(要件 8.4)
- BS8Kフィルタの動作確認(要件 8.5)
- サブチャンネル重複削除の動作確認(要件 8.6)
- Discord通知の動作確認(要件 8.7)

注: 統合テストは実際のAPIキーとWebhook URLが必要です。

### テスト実行

```bash
# 単体テスト
bundle exec rspec spec/unit/

# プロパティベーステスト
bundle exec rspec spec/property/

# 統合テスト(実際のAPI使用)
bundle exec rspec spec/integration/
```

## 実装上の注意事項

### v3 API調査が必要な項目

実装前に以下の項目をNHK API Portal (https://api-portal.nhk.or.jp/) で確認する必要があります:

1. **エンドポイントURL**
   - ジャンル検索: `/v3/pg/genre/...` の正確な形式
   - リスト検索: `/v3/pg/list/...` の正確な形式

2. **認証方法**
   - APIキーの渡し方(クエリパラメータ `?key=` vs ヘッダー `X-API-Key`)
   - 認証エラーのレスポンス形式

3. **レスポンス構造**
   - フィールド名の変更(例: `start_time` vs `startTime`)
   - ネスト構造の変更
   - 新しいフィールドの追加
   - 削除されたフィールド

4. **コードマッピング**
   - 地域コード(Area ID)の変更有無
   - サービスコード(Service ID)の変更有無
   - ジャンルコード(Genre ID)の変更有無
   - サービス名・ジャンル名の変更有無

5. **制約事項**
   - レート制限
   - リクエストサイズ制限
   - レスポンスサイズ制限
   - タイムアウト設定

### 段階的移行アプローチ

1. **フェーズ1: v3 API調査**
   - API仕様書の確認
   - サンプルリクエストの実行
   - レスポンス構造の分析

2. **フェーズ2: コード更新**
   - エンドポイントURLの更新
   - レスポンスパーサーの更新
   - 定数マッピングの更新

3. **フェーズ3: テスト**
   - 単体テストの実装と実行
   - プロパティベーステストの実装と実行
   - 統合テストの実行

4. **フェーズ4: デプロイ**
   - 開発環境へのデプロイ
   - 動作確認
   - 本番環境へのデプロイ

### 後方互換性の維持

- Lambdaイベントペイロード形式は変更しない
- 環境変数名は変更しない
- SSMパラメータ名は変更しない
- SAMテンプレートの構造は変更しない
- Discord通知のメッセージ形式は変更しない

これにより、既存のEventBridgeルールやスケジュールされたイベントは変更なしで動作し続けます。
