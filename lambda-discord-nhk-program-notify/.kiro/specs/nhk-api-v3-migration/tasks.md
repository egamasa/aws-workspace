# 実装計画: NHK API v3移行

## 概要

NHK番組通知Lambda関数をAPI v2からv3へ移行します。既存の機能を維持しながら、エンドポイントとレスポンス処理を更新します。

## タスク

- [x] 1. NHK API v3の調査と仕様確認
  - NHK API Portal (https://api-portal.nhk.or.jp/) でv3仕様を確認
  - v3エンドポイントURL形式を確認(ジャンル検索、リスト検索)
  - 認証方法の確認(クエリパラメータ vs ヘッダー)
  - レスポンス構造の確認(フィールド名、ネスト構造)
  - 地域・サービス・ジャンルコードの変更有無を確認
  - レート制限や制約事項を確認
  - _要件: 1.1, 1.2, 1.4, 2.1, 2.2, 3.1, 3.2, 3.3_

- [x] 2. APIエンドポイントの更新
  - [x] 2.1 app.rbのエンドポイントURL定数を更新
    - `API_BASE_URL_GENRE`をv3形式に更新
    - `API_BASE_URL_LIST`をv3形式に更新
    - v2への参照をすべて削除
    - _要件: 1.1, 1.2, 1.3, 1.5_

  - [x] 2.2 認証方法の更新(必要な場合)
    - v3の認証形式を実装(クエリパラメータまたはヘッダー)
    - `fetch_programs`メソッドを更新
    - _要件: 1.4, 5.2, 5.3_

- [x] 3. レスポンスパーサーの更新
  - [x] 3.1 v3レスポンス構造に対応
    - `fetch_programs`メソッドのレスポンス解析を更新
    - フィールド名の変更に対応(例: start_time → startTime)
    - ネスト構造の変更に対応
    - _要件: 2.1, 2.2, 2.3, 2.5_

  - [x] 3.2 `search_programs`メソッドの更新
    - v3レスポンス構造での番組リスト反復処理を更新
    - フィールドアクセスをv3形式に更新
    - _要件: 2.4_

  - [x] 3.3 `send_message`メソッドの更新
    - v3レスポンスフィールドでのメッセージフォーマットを更新
    - Discord通知の構造と内容を維持
    - _要件: 4.6_

- [x] 4. 定数マッピングの検証と更新
  - [x] 4.1 constants.rbの検証
    - v3で有効なArea_IDコードを確認
    - v3で有効なService_IDコードを確認
    - v3で有効なGenre_IDコードを確認
    - _要件: 3.1, 3.2, 3.3_

  - [x] 4.2 定数の更新(必要な場合)
    - 変更されたコードマッピングを更新
    - 変更されたサービス名・ジャンル名を更新
    - _要件: 3.4, 3.5_

- [ ] 5. エラーハンドリングの強化
  - [ ] 5.1 API通信エラー処理の実装
    - `fetch_programs`にtry-catchブロックを追加
    - HTTPエラーステータスの処理を追加
    - エラーログ出力を追加
    - _要件: 6.1, 6.2_

  - [ ] 5.2 レスポンス解析エラー処理の実装
    - JSON解析エラーの処理を追加
    - 予期しないレスポンス構造の処理を追加
    - エラーログ出力を追加
    - _要件: 6.3_

  - [ ] 5.3 Discord通知エラー処理の実装
    - `send_message`にtry-catchブロックを追加
    - エラーログ出力を追加(Lambda実行は継続)
    - _要件: 6.5_

- [x] 6. チェックポイント - 基本機能の動作確認
  - すべてのコード変更が完了していることを確認
  - 構文エラーがないことを確認
  - ユーザーに質問があれば確認

- [ ] 7. テストの実装
  - [ ] 7.1 テスト環境のセットアップ
    - Gemfileにrspec、rantyを追加
    - spec/ディレクトリ構造を作成(unit/, property/, integration/)
    - spec_helper.rbを作成
    - _要件: 8.1-8.7_

  - [ ]\*7.2 単体テストの実装
    - v3エンドポイント使用の確認テスト
    - v3認証形式の確認テスト
    - SSMパラメータ取得のテスト(モック使用)
    - 環境変数サポートのテスト
    - 空の番組リストのテスト
    - デフォルト地域値のテスト
    - 複数イベントオブジェクトのテスト
    - エッジケースのテスト
    - _要件: 1.1, 1.2, 1.4, 5.1, 5.4, 5.5, 6.4, 10.3, 10.4_

  - [ ]\*7.3 プロパティベーステストの実装 - レスポンス処理
    - **プロパティ1: v3レスポンスの正しい解析**
    - **検証: 要件 2.1**

  - [ ]\*7.4 プロパティベーステストの実装 - フィールドマッピング
    - **プロパティ2: フィールドマッピングの完全性**
    - **検証: 要件 2.2**

  - [ ]\*7.5 プロパティベーステストの実装 - 番組リスト処理
    - **プロパティ3: 番組リストの正しい反復処理**
    - **検証: 要件 2.4**

  - [ ]\*7.6 プロパティベーステストの実装 - ジャンル検索
    - **プロパティ4: ジャンル検索の一貫性**
    - **検証: 要件 4.1**

  - [ ]\*7.7 プロパティベーステストの実装 - キーワードフィルタリング
    - **プロパティ5: キーワードフィルタリングの正確性**
    - **検証: 要件 4.2**

  - [ ]\*7.8 プロパティベーステストの実装 - BS8K除外
    - **プロパティ6: BS8K除外の正確性**
    - **検証: 要件 4.3**

  - [ ]\*7.9 プロパティベーステストの実装 - 重複削除
    - **プロパティ7: サブチャンネル重複削除の正確性**
    - **検証: 要件 4.4**

  - [ ]\*7.10 プロパティベーステストの実装 - ソート
    - **プロパティ8: 開始時刻ソートの正確性**
    - **検証: 要件 4.5**

  - [ ]\*7.11 プロパティベーステストの実装 - メッセージフォーマット
    - **プロパティ9: Discordメッセージフォーマットの一貫性**
    - **検証: 要件 4.6**

  - [ ]\*7.12 プロパティベーステストの実装 - イベントペイロード
    - **プロパティ10: イベントペイロード互換性**
    - **検証: 要件 4.7**

  - [ ]\*7.13 プロパティベーステストの実装 - APIエラー処理
    - **プロパティ11: APIエラーの適切な処理**
    - **検証: 要件 6.1, 6.2**

  - [ ]\*7.14 プロパティベーステストの実装 - 不正レスポンス処理
    - **プロパティ12: 不正レスポンスの処理**
    - **検証: 要件 6.3**

  - [ ]\*7.15 統合テストの実装
    - 実際のNHK API v3を使用したテスト
    - ジャンル検索の動作確認
    - キーワード検索の動作確認
    - 異なる地域・サービスでの動作確認
    - BS8Kフィルタの動作確認
    - 重複削除の動作確認
    - Discord通知の動作確認
    - _要件: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

- [ ] 8. チェックポイント - すべてのテストが成功することを確認
  - 単体テストを実行
  - プロパティベーステストを実行
  - 統合テストを実行(実際のAPIキー使用)
  - すべてのテストが成功することを確認
  - ユーザーに質問があれば確認

- [ ] 9. ドキュメントの更新
  - [ ] 9.1 READMEの更新
    - v3 APIへの参照を追加
    - v3エンドポイントURLを記載
    - v2からv3への主な変更点を記載
    - v3固有の設定や要件を記載
    - レート制限や制約事項を記載(該当する場合)
    - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ] 9.2 コードコメントの更新
    - v2への参照をv3に更新
    - 変更理由を記載
    - _要件: 9.3_

- [ ] 10. 最終チェックポイント - デプロイ準備完了確認
  - すべてのコード変更が完了していることを確認
  - すべてのテストが成功していることを確認
  - ドキュメントが更新されていることを確認
  - SAMテンプレートが変更されていないことを確認
  - 後方互換性が維持されていることを確認
  - ユーザーに質問があれば確認

## 注意事項

- `*`マークのタスクはオプションであり、より迅速なMVPのためにスキップ可能です
- 各タスクは特定の要件を参照しており、トレーサビリティを確保しています
- チェックポイントは段階的な検証を保証します
- プロパティテストは普遍的な正確性プロパティを検証します
- 単体テストは特定の例とエッジケースを検証します
- 統合テストは実際のAPIキーとWebhook URLが必要です

## デプロイ手順(参考)

実装完了後、以下の手順でデプロイします:

```bash
# 1. テストの実行
bundle exec rspec

# 2. SAMビルド
sam build

# 3. 開発環境へのデプロイ
sam deploy --config-env dev

# 4. 動作確認
# EventBridgeルールを手動実行、またはテストイベントを送信

# 5. 本番環境へのデプロイ
sam deploy --config-env prod
```

注: 実際のデプロイ手順は既存のCI/CDパイプラインに従ってください。
